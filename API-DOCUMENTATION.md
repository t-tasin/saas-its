# IT Helpdesk API Documentation

## üîê Authentication

All services run in **DEV mode** by default, which allows:
- Unauthenticated requests (uses default admin user)
- JWT tokens generated by `/auth/register` and `/auth/login`
- Simple token validation (not production-ready)

For **production**, configure proper JWT with RS256 signing.

---

## Services & Ports

| Service | Port | Swagger Docs |
|---------|------|--------------|
| Identity Service | 3000 | http://localhost:3000/docs |
| Ticket Service | 3001 | http://localhost:3001/docs |
| Asset Service | 3002 | http://localhost:3002/docs |

---

## üÜî Identity Service (Port 3000)

### Public Endpoints (No Auth Required)

#### Register User
```http
POST /v1/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123!",  // Min 8 chars
  "name": "John Doe",             // Optional
  "role": "general"               // general | operator | admin (default: general)
}

Response:
{
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "John Doe",
    "role": "general",
    "isActive": true,
    "createdAt": "2025-10-09T15:00:00.000Z",
    "updatedAt": "2025-10-09T15:00:00.000Z"
  },
  "token": "eyJhbGci...",
  "refreshToken": "abc123..."
}
```

#### Login
```http
POST /v1/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123!"
}

Response: Same as register
```

### Authenticated Endpoints

#### Get Current User Profile
```http
GET /v1/auth/me
Authorization: Bearer {token}

Response:
{
  "id": "uuid",
  "email": "user@example.com",
  "name": "John Doe",
  "role": "general",
  "isActive": true,
  "createdAt": "2025-10-09T15:00:00.000Z",
  "updatedAt": "2025-10-09T15:00:00.000Z"
}
```

#### Update Profile
```http
PATCH /v1/auth/me
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "John Smith"  // Optional
}

Response: Updated user object
```

#### Change Password
```http
POST /v1/auth/change-password
Authorization: Bearer {token}
Content-Type: application/json

{
  "currentPassword": "OldPass123!",
  "newPassword": "NewPass123!"
}

Response:
{
  "message": "Password changed successfully"
}
```

### Admin Only Endpoints

#### List Users
```http
GET /v1/users?role={role}&isActive={true|false}
Authorization: Bearer {admin-token}

Response:
[
  {
    "id": "uuid",
    "email": "user@example.com",
    "name": "John Doe",
    "role": "general",
    "isActive": true,
    "createdAt": "2025-10-09T15:00:00.000Z",
    "updatedAt": "2025-10-09T15:00:00.000Z"
  }
]
```

#### Create User (Admin creates operators/admins)
```http
POST /v1/users
Authorization: Bearer {admin-token}
Content-Type: application/json

{
  "email": "operator@example.com",
  "password": "OpPass123!",
  "name": "Operator Name",
  "role": "operator"  // operator | admin
}

Response: User object
```

#### Get User by ID
```http
GET /v1/users/{userId}
Authorization: Bearer {admin-token}

Response: User object
```

#### Update User
```http
PATCH /v1/users/{userId}
Authorization: Bearer {admin-token}
Content-Type: application/json

{
  "name": "Updated Name",
  "role": "admin",
  "isActive": false
}

Response: Updated user object
```

#### Deactivate User
```http
DELETE /v1/users/{userId}
Authorization: Bearer {admin-token}

Response:
{
  "message": "User deactivated successfully"
}
```

---

## üé´ Ticket Service (Port 3001)

### Public Endpoints (No Auth Required)

#### List Tickets
```http
GET /v1/tickets?status={status}&type={type}&q={search}&limit={50}&cursor={cursor}

Parameters:
- status: open | in_progress | resolved | closed
- type: incident | request
- q: Search in title/description
- limit: Results per page (max 100)
- cursor: Pagination cursor

Response:
{
  "items": [
    {
      "id": "uuid",
      "number": "251009-0001",  // Auto-generated YYMMDD-####
      "title": "Laptop not working",
      "description": "Cannot boot",
      "type": "incident",
      "status": "open",
      "priority": "high",  // low | medium | high | urgent
      "requestedBy": "user@example.com",  // For unauthenticated users
      "requestedByUser": "uuid",           // For authenticated users
      "assignedTo": null,
      "categoryId": null,
      "subcategoryId": null,
      "targetDate": null,
      "createdAt": "2025-10-09T15:00:00.000Z",
      "updatedAt": "2025-10-09T15:00:00.000Z",
      "category": null,
      "subcategory": null
    }
  ],
  "nextCursor": "base64cursor" // null if last page
}
```

#### Create Ticket
```http
POST /v1/tickets
Content-Type: application/json

{
  "title": "Printer not working",
  "description": "Cannot print documents",
  "type": "incident",        // Optional: incident | request
  "priority": "medium",      // Optional: low | medium | high | urgent
  "requestedBy": "user@example.com",  // For unauthenticated users
  "categoryId": "uuid",      // Optional
  "subcategoryId": "uuid"    // Optional
}

Response: Ticket object with auto-generated number
```

#### Get Ticket
```http
GET /v1/tickets/{ticketId}

Response: Ticket object with category, subcategory, and comments included
```

#### List Comments
```http
GET /v1/tickets/{ticketId}/comments

Response:
[
  {
    "id": "uuid",
    "ticketId": "uuid",
    "authorId": null,              // UUID if authenticated
    "authorName": "John Doe",      // Name for unauthenticated
    "body": "Comment text",
    "createdAt": "2025-10-09T15:00:00.000Z"
  }
]
```

#### Create Comment
```http
POST /v1/tickets/{ticketId}/comments
Content-Type: application/json

{
  "authorName": "John Doe",  // For unauthenticated users
  "body": "This is my comment"
}

Response: Comment object
```

### Operator/Admin Only Endpoints

#### Update Ticket Status
```http
PATCH /v1/tickets/{ticketId}/status
Authorization: Bearer {operator-or-admin-token}
Content-Type: application/json

{
  "status": "in_progress"  // open | in_progress | resolved | closed
}

Response: Updated ticket object
```

---

## üñ•Ô∏è Asset Service (Port 3002)

### All Endpoints Require Operator/Admin Role

#### List Assets
```http
GET /v1/assets?q={search}&limit={50}&cursor={cursor}
Authorization: Bearer {operator-or-admin-token}

Parameters:
- q: Search in assetTag or summary
- limit: Results per page (max 100)
- cursor: Pagination cursor

Response:
{
  "items": [
    {
      "id": "uuid",
      "assetTag": "MBP-001",
      "assetTypeId": "uuid",
      "summary": "MacBook Pro 14",
      "location": "Office A",
      "status": "available",  // available | assigned | maintenance | retired
      "createdAt": "2025-10-09T15:00:00.000Z",
      "updatedAt": "2025-10-09T15:00:00.000Z",
      "assetType": {
        "id": "uuid",
        "name": "Laptop",
        "createdAt": "2025-10-09T15:00:00.000Z"
      },
      "assignments": [  // Only active assignments
        {
          "id": "uuid",
          "assetId": "uuid",
          "personId": "user-uuid",
          "assignedAt": "2025-10-09T15:00:00.000Z",
          "unassignedAt": null
        }
      ]
    }
  ],
  "nextCursor": "base64cursor"
}
```

#### Create Asset
```http
POST /v1/assets
Authorization: Bearer {operator-or-admin-token}
Content-Type: application/json

{
  "assetTag": "MBP-003",
  "assetTypeId": "uuid",  // Required
  "summary": "MacBook Air M3",
  "location": "Office B"  // Optional
}

Response: Asset object
```

#### Assign Asset
```http
POST /v1/assets/{assetId}/assign
Authorization: Bearer {operator-or-admin-token}
Content-Type: application/json

{
  "personId": "user-uuid"  // User ID to assign to
}

Response: Assignment object
```

#### Unassign Asset
```http
POST /v1/assets/{assetId}/unassign
Authorization: Bearer {operator-or-admin-token}

Response:
{
  "ok": true,
  "message": "Asset unassigned"
}
```

---

## üîë User Roles & Permissions

| Role | Permissions |
|------|------------|
| **general** | - Create tickets (public)<br>- Add comments (public)<br>- View tickets (public) |
| **operator** | - All general permissions<br>- Update ticket status<br>- View/manage assets<br>- Assign/unassign assets |
| **admin** | - All operator permissions<br>- Create/manage users<br>- View all users<br>- Deactivate users |

---

## üìù Response Format

### Success Response
```json
{
  // Response data
}
```

### Error Response
```json
{
  "error": {
    "code": "ERROR_CODE",  // UNAUTHORIZED, FORBIDDEN, NOT_FOUND, etc.
    "message": "Human readable error message"
  },
  "path": "/v1/endpoint",
  "ts": "2025-10-09T15:00:00.000Z"
}
```

---

## üöÄ Quick Start for Frontend

### 1. Start Services
```bash
# Start infrastructure
make up

# Bootstrap database
make db.bootstrap

# Start services (each in separate terminal)
cd services/identity-svc && DATABASE_URL="postgresql://app:app@localhost:5432/app?schema=identity" PORT=3000 npm start
cd services/ticket-svc && DATABASE_URL="postgresql://app:app@localhost:5432/app?schema=ticket" PORT=3001 npm start
cd services/asset-svc && DATABASE_URL="postgresql://app:app@localhost:5432/app?schema=asset" PORT=3002 npm start
```

### 2. Register & Login
```javascript
// Register
const response = await fetch('http://localhost:3000/v1/auth/register', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'user@example.com',
    password: 'SecurePass123!',
    name: 'John Doe',
    role: 'general'
  })
});

const { user, token, refreshToken } = await response.json();

// Store token
localStorage.setItem('token', token);
localStorage.setItem('refreshToken', refreshToken);
localStorage.setItem('user', JSON.stringify(user));
```

### 3. Make Authenticated Requests
```javascript
const token = localStorage.getItem('token');

const response = await fetch('http://localhost:3001/v1/tickets/123/status', {
  method: 'PATCH',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({ status: 'in_progress' })
});
```

### 4. Handle Unauthenticated Requests (General Users)
```javascript
// No token needed for creating tickets
const response = await fetch('http://localhost:3001/v1/tickets', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    title: 'My computer is broken',
    description: 'Details here',
    type: 'incident',
    priority: 'high',
    requestedBy: 'user@email.com'  // Email for tracking
  })
});
```

---

## ‚ö†Ô∏è Important Notes

1. **DEV Mode**: Currently in development mode
   - Tokens use simple HMAC signing (not secure for production)
   - Requests without tokens use default admin user
   - In production, use proper RS256 JWT with Auth0/Cognito

2. **CORS**: All services allow `http://localhost:3000`
   - Update CORS settings for your frontend URL in production

3. **Passwords**: 
   - Minimum 8 characters
   - Stored with bcrypt hashing (10 salt rounds)

4. **Ticket Numbers**: Auto-generated as `YYMMDD-####` (e.g., `251009-0001`)

5. **Pagination**: Uses cursor-based pagination
   - Pass `nextCursor` from response to get next page
   - `nextCursor` is `null` on last page

---

## üìû Support

For API issues or questions:
- Check Swagger documentation at each service's `/docs` endpoint
- Review test script: `/test-auth.sh`
- Check service logs in `/tmp/*-svc.log`

